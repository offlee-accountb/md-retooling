# HWPX 템플릿 주입 시스템 워크플로우

> **작성일**: 2025-11-29  
> **목적**: 전체 시스템 구조 및 세부 워크플로우 정리

---

## 1. 전체 시스템 블록 다이어그램

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           HWPX 템플릿 주입 시스템                            │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│   BLOCK A    │    │   BLOCK B    │    │   BLOCK C    │    │   BLOCK D    │
│              │    │              │    │              │    │              │
│  템플릿 분석  │───▶│  프롬프트    │───▶│  데이터 수집  │───▶│  HWPX 주입   │
│              │    │  생성        │    │  & 검증      │    │  & 출력      │
└──────────────┘    └──────────────┘    └──────────────┘    └──────────────┘
       │                   │                   │                   │
       ▼                   ▼                   ▼                   ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│ TemplateInfo │    │ LLM Prompt   │    │ StructuredData│   │ Output HWPX  │
│ (구조 정보)   │    │ (질문 생성)  │    │ (MD 파싱)     │    │ (최종 문서)  │
└──────────────┘    └──────────────┘    └──────────────┘    └──────────────┘
```

### 입력/출력 요약

| Block | 입력 | 출력 | 담당 모듈 |
|-------|------|------|----------|
| A | 템플릿 HWPX | TemplateInfo | `TemplateAnalyzer` |
| B | TemplateInfo + 컨텍스트 | LLM 프롬프트 | `generate_prompt()` |
| C | LLM 응답 (MD) | StructuredData | `MDParser` |
| D | StructuredData + 템플릿 | 완성된 HWPX | `StructuredInjector` |

---

## 2. BLOCK A: 템플릿 분석

```
                    ┌─────────────────┐
                    │  템플릿 HWPX    │
                    │  (정부양식 등)   │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │  HWPX 압축해제  │
                    │  section*.xml   │
                    └────────┬────────┘
                             │
          ┌──────────────────┼──────────────────┐
          ▼                  ▼                  ▼
   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
   │ 테이블 구조  │    │ 키워드 패턴  │    │ 섹션 패턴   │
   │ 분석        │    │ 추출        │    │ 추출        │
   │             │    │             │    │             │
   │ - 행/열 수   │    │ - (키워드)  │    │ - < 제목 >  │
   │ - 주제목표   │    │ - name=""   │    │             │
   │ - 데이터표   │    │ - {{KEY}}   │    │             │
   └──────┬──────┘    └──────┬──────┘    └──────┬──────┘
          │                  │                  │
          └──────────────────┼──────────────────┘
                             ▼
                    ┌─────────────────┐
                    │  TemplateInfo   │
                    ├─────────────────┤
                    │ • title_table   │
                    │ • data_tables[] │
                    │ • keywords[]    │
                    │ • sections[]    │
                    │ • table_headers │
                    └─────────────────┘
```

### 감지되는 패턴 유형

| 유형 | 패턴 | 예시 | 용도 |
|------|------|------|------|
| 주제목 표 | 3x1 테이블 | 문서 상단 제목 박스 | 문서 제목 |
| 키워드 | `(키워드)` | `(추진 배경)` | 인라인 데이터 |
| 정부양식 | `name="AAA*..."` | `name="STSU_MAST*BUSI_NM"` | 공공문서 |
| 플레이스홀더 | `{{KEY}}` | `{{TITLE}}` | 범용 치환 |
| 섹션 | `< 제목 >` | `< 지역별 실증 역량 >` | 구조 구분 |
| 데이터 표 | NxM 테이블 | 7행 x 6열 | 표 데이터 |

---

## 3. BLOCK B: 프롬프트 생성

```
┌─────────────────┐    ┌─────────────────┐
│  TemplateInfo   │    │  참고자료       │
│  (분석 결과)     │    │  (선택사항)     │
└────────┬────────┘    └────────┬────────┘
         │                      │
         └──────────┬───────────┘
                    ▼
           ┌─────────────────┐
           │  프롬프트 생성   │
           │  generate_prompt │
           └────────┬────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│           LLM 프롬프트 출력              │
├─────────────────────────────────────────┤
│                                         │
│  # 데이터 입력 요청                      │
│                                         │
│  ## 필요한 데이터                        │
│                                         │
│  ### 1. 주제목                          │
│  ```                                    │
│  <주제목> [문서의 주제목을 입력]          │
│  ```                                    │
│                                         │
│  ### 2. 키워드 필드                      │
│  ```                                    │
│  ◦ (추진 배경) [내용 입력]               │
│  ◦ (구성) [내용 입력]                    │
│  ```                                    │
│                                         │
│  ### 3. 표 데이터                        │
│  ```                                    │
│  | 구분 | 지역 | 예산 | ... |            │
│  | --- | --- | --- | --- |             │
│  | 데이터 | 데이터 | ... |               │
│  ```                                    │
│                                         │
│  ## 참고 자료                            │
│  [원본 문서 내용...]                     │
│                                         │
└─────────────────────────────────────────┘
```

### 프롬프트 구성 요소

| 섹션 | 내용 | 목적 |
|------|------|------|
| 필요한 데이터 | 채워야 할 필드 목록 | LLM이 뭘 제공해야 하는지 명확화 |
| 표 헤더 | 템플릿에서 추출한 컬럼명 | 정확한 데이터 구조 유도 |
| 참고 자료 | 원본 문서, 기존 데이터 | LLM이 내용 생성에 활용 |
| 출력 형식 | MD 문법 안내 | 파싱 가능한 형태로 응답 유도 |

---

## 4. BLOCK C: 데이터 수집 & 검증

```
┌─────────────────────────────────────────┐
│          LLM 프롬프트                    │
│   (Block B에서 생성)                     │
└────────────────┬────────────────────────┘
                 │
                 ▼
        ┌─────────────────┐
        │                 │
        │   LLM / 사용자   │◀──── 외부 데이터 소스
        │   데이터 제공    │      (DB, API, 문서 등)
        │                 │
        └────────┬────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│           MD 형식 응답                   │
├─────────────────────────────────────────┤
│ <주제목> 스마트제조 테스트베드 현황...    │
│                                         │
│ ◦ (추진 배경) 중소기업의 스마트공장...    │
│ ◦ (구성) 지역별 산업 특성과 수요에...     │
│                                         │
│ | 구분 | 지역 | 예산 | 사업연도 | ...    │
│ | --- | --- | --- | --- | ...          │
│ | 권역별 테스트베드 | 부산 | 48 | ...    │
└────────────────┬────────────────────────┘
                 │
                 ▼
        ┌─────────────────┐
        │   MDParser      │
        │   파싱 & 검증    │
        └────────┬────────┘
                 │
                 ▼
        ┌─────────────────┐
        │ StructuredData  │
        ├─────────────────┤
        │ • title         │
        │ • keywords{}    │
        │ • tables[]      │
        │ • sections{}    │
        └─────────────────┘
```

### 데이터 소스 옵션

| 소스 | 설명 | 자동화 수준 |
|------|------|------------|
| LLM (Haiku 등) | AI가 참고자료 기반 생성 | 높음 |
| 사용자 직접 입력 | MD 파일 수동 작성 | 낮음 |
| DB 쿼리 | 기존 데이터베이스에서 추출 | 중간 |
| API 연동 | 외부 시스템에서 데이터 fetch | 높음 |

### 검증 체크리스트

- [ ] 필수 필드 (주제목, 키워드) 존재 여부
- [ ] 표 데이터 행/열 수 일치 여부
- [ ] 데이터 타입 검증 (숫자, 날짜 등)
- [ ] 빈 셀 처리 정책

---

## 5. BLOCK D: HWPX 주입 & 출력

```
┌─────────────────┐    ┌─────────────────┐
│ StructuredData  │    │  템플릿 HWPX    │
│ (파싱된 데이터)  │    │  (원본)         │
└────────┬────────┘    └────────┬────────┘
         │                      │
         └──────────┬───────────┘
                    ▼
           ┌─────────────────┐
           │  HWPX 압축해제   │
           │  임시 디렉토리    │
           └────────┬────────┘
                    │
    ┌───────────────┼───────────────┐
    ▼               ▼               ▼
┌────────┐    ┌──────────┐    ┌──────────┐
│ 주제목  │    │ 키워드    │    │ 표 데이터 │
│ 주입    │    │ 주입      │    │ 주입      │
│         │    │           │    │           │
│ 표 0    │    │ (키워드)  │    │ 표 1~N   │
│ row 1   │    │ → 값 추가 │    │ 셀 매핑   │
└────┬───┘    └─────┬─────┘    └─────┬────┘
     │              │                │
     └──────────────┼────────────────┘
                    ▼
           ┌─────────────────┐
           │ linesegarray    │
           │ 제거            │◀──── 자동 줄바꿈 보장
           └────────┬────────┘
                    │
                    ▼
           ┌─────────────────┐
           │  HWPX 재압축    │
           │  (mimetype 먼저) │
           └────────┬────────┘
                    │
                    ▼
           ┌─────────────────┐
           │  출력 HWPX      │
           │  완성된 문서     │
           └─────────────────┘
```

### 주입 전략

| 대상 | 위치 찾기 | 주입 방식 |
|------|----------|----------|
| 주제목 | 3x1 표의 row=1 셀 | `<hp:t>` 텍스트 교체 |
| 키워드 | `(키워드)` 텍스트 찾기 | 뒤에 값 추가 |
| 표 데이터 | `cellAddr` 좌표 매칭 | 셀별 텍스트 설정 |
| 정부양식 | `name=""` 속성 매칭 | 해당 셀에 값 설정 |

### 후처리

| 작업 | 목적 | 방법 |
|------|------|------|
| linesegarray 제거 | 자동 줄바꿈 | 정규식으로 태그 삭제 |
| 네임스페이스 유지 | XML 유효성 | ET.register_namespace |
| mimetype 압축 | HWPX 규격 | ZIP_STORED (비압축) |

---

## 6. 전체 CLI 사용 흐름 (Smart Injector v3)

```bash
# ═══════════════════════════════════════════════════════════
#  STEP 1: 템플릿 분석 + 프롬프트/템플릿 생성
# ═══════════════════════════════════════════════════════════
$ python smart_injector.py analyze template.hwpx -o prefix

# 출력:
#   prefix_fields.yaml  (빈 입력 템플릿)
#   prefix_prompt.md    (LLM/사용자에게 질문)


# ═══════════════════════════════════════════════════════════
#  STEP 2: 데이터 수집 (LLM 또는 수동)
# ═══════════════════════════════════════════════════════════
# 옵션 A: LLM 호출 후 응답 저장
$ cat prefix_prompt.md | llm-cli --model haiku > response.txt

# 옵션 B: 수동으로 "라벨: 값" 형식으로 작성
$ vi response.txt


# ═══════════════════════════════════════════════════════════
#  STEP 3: 응답 파싱 → YAML 변환
# ═══════════════════════════════════════════════════════════
$ python smart_injector.py parse response.txt -o fields.yaml


# ═══════════════════════════════════════════════════════════
#  STEP 4: HWPX 주입
# ═══════════════════════════════════════════════════════════
$ python smart_injector.py inject template.hwpx fields.yaml -o result.hwpx

✅ 주입 성공: 25개
📁 출력: result.hwpx


# ═══════════════════════════════════════════════════════════
#  또는 STEP 2-4 한번에: full 명령
# ═══════════════════════════════════════════════════════════
$ python smart_injector.py full template.hwpx --response response.txt -o result.hwpx
```

---

## 7. 파일 구조

```
injector/
├── smart_injector.py        # 메인 통합 CLI (v3)
│   ├── analyze 서브커맨드   # HWPX → prompt.md + fields.yaml
│   ├── parse 서브커맨드     # response.txt → fields.yaml
│   ├── inject 서브커맨드    # 주입 실행
│   └── full 서브커맨드      # 전체 파이프라인
│
├── templates/               # YAML 템플릿
│   ├── input_template.yaml
│   └── data_collection_prompt.yaml
│
├── structured_injector.py   # 레거시 (참고용)
├── keyword_injector.py      # 키워드 전용 (레거시)
└── unified_injector.py      # 범용 주입기 (레거시)

input/
├── hwpx_templates/          # 템플릿 파일들
│   ├── (1-1).hwpx          # 키워드 패턴
│   ├── (1-2).hwpx          # 표 데이터 패턴
│   └── (1-5).hwpx          # 복합 패턴
└── test_data/              # 테스트 데이터

output/
├── test_1-1_injected.hwpx
├── test_1-5_injected.hwpx
└── ...
```

---

## 8. 향후 확장 계획

### 단기 (Phase 2.5 완료 ✅)
- [x] 키워드 패턴 주입
- [x] 표 데이터 주입
- [x] 프롬프트 자동 생성
- [x] linesegarray 자동 제거
- [x] Smart Injector v3 통합 CLI
- [x] 자동 필드 탐지 (analyze)
- [x] 응답 파싱 (parse)
- [x] 5가지 주입 모드 (NEXT_CELL, APPEND, REPLACE, SKIP_COLON, PREPEND)
- [x] 날짜 자동 주입 (단일/분리 셀)
- [x] 서명란 자동 주입

### 중기 (Phase 3)
- [ ] 정부양식 `name=""` 패턴 완전 지원
- [ ] 복수 섹션 파일 처리
- [ ] 이미지/차트 주입
- [ ] 스타일 자동 매칭

### 장기 (Phase 4)
- [ ] LLM API 직접 연동
- [ ] 웹 UI / API 서버
- [ ] 배치 처리 (다수 문서)
- [ ] 검증 & 피드백 루프

---

*마지막 업데이트: 2025-11-30 (Smart Injector v3 반영)*
